# Marketplace API (v0.5.0)

Base URL: https://api.infinityweb.app

This documentation and the API itself is under active development, and can change at any time without warning. Please
make sure that you keep your code updated with this.

## Authentication

1. Sign-in or Sign up
    1. Make a sign-in request (Endpoint#30 POST `/users/login`) with `email` and `password` in the request body.
    2. Alternatively, make a sign-up request (Endpoint#29 POST `/users/register`) with `name` (optional), `email`
       and `password` in the request body.
2. The step above will provide a `User` object as a successful response, that should contain a `token`.
3. The value of this `token` is to be used in `Authorization` header to access any protected endpoint.
4. All the users signed up will have `User` role, for any other role, please write
   to [Alok Shukla](mailto:alok@clay.fish). This is due to the ability to add new `App` and `Solution` will only be with
   a very few team members that can be manually modified.

## API Documentation

User roles: [`User`, `Admin`, `AppEditor`, `SolutionEditor`, `PlanEditor`]

**MRR**: Minimum Required Role

### AppAccounts

| Sr No | Method   | Endpoint           | MRR    | Request                                                                        | Response                                   | Comments                                                                       |
|-------|----------|--------------------|--------|--------------------------------------------------------------------------------|--------------------------------------------|--------------------------------------------------------------------------------|
| 1     | `GET`    | `/appAccounts`     | `User` | Query param: `app` accepts ID of an [App](Models.md#app) or appCode of an app. | 200 [`AppAccount[]`](Models.md#appaccount) | Lists all the appAccounts for the authenticated user.                          |
| 2     | `POST`   | `/appAccounts`     | `User` | [`AppAccountCreationAttributes`](Models.md#appaccountcreationattributes)       | 201 [`AppAccount`](Models.md#appaccount)   | Creates a new [`AppAccount`](Models.md#appaccount) for the authenticated user. |
| 3     | `GET`    | `/appAccounts/:id` | `User` |                                                                                | 200 [`AppAccount`](Models.md#appaccount)   | Get one [`AppAccount`](Models.md#appaccount) for the authenticated user.       |
| 4     | `PUT`    | `/appAccounts/:id` | `User` | [`AppAccountCreationAttributes`](Models.md#appaccountcreationattributes)       | 200 or 400                                 | Supplied body must contain `id`.                                               |
| 5     | `DELETE` | `/appAccounts/:id` | `User` |                                                                                | 200 or 400                                 | Delete the [`AppAccount`](Models.md#appaccount).                               |

### Apps

| Sr No | Method   | Endpoint                   | MRR         | Request                                                                                            | Response                                                                                                                        | Comments                                                                                                                                                                                                                   |
|-------|----------|----------------------------|-------------|----------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 6     | `GET`    | `/apps`                    |             | Query params-<br/><ul><li>`pageSize`: `number?` = 20</li><li>`pageNumber`: `number?` = 1</li></ul> | <pre>{<br/>&nbsp;&nbsp;data: [App](Models.md#app)[],<br/>&nbsp;&nbsp;pagination: [Pagination](Models.md#pagination)<br/>}</pre> | Lists all apps.                                                                                                                                                                                                            |
| 7     | `POST`   | `/apps`                    | `AppEditor` | [`AppCreationAttributes`](Models.md#appcreationattributes)                                         | 201 [`App`](Models.md#app)                                                                                                      | Creates a new [`App`](Models.md#app) for all the users to use.                                                                                                                                                             |
| 8     | `GET`    | `/apps/:idOrSlug`          |             |                                                                                                    | 200 [`App`](Models.md#app)                                                                                                      | Get one [`App`](Models.md#app)                                                                                                                                                                                             |
| 9     | `PUT`    | `/apps/:idOrSlug`          | `AppEditor` | [`AppCreationAttributes`](Models.md#appcreationattributes)                                         | 501                                                                                                                             | CAUTION: For apps that have [AppAccounts](Models.md#appaccount) added by [Users](Models.md#user), the name of the existing fields should not be changed. While making this request, make sure you know what you are doing. |
| 10    | `DELETE` | `/apps/:idOrSlug`          | `AppEditor` |                                                                                                    | 200                                                                                                                             | Delete the [`App`](Models.md#app).                                                                                                                                                                                         |
| 11    | `GET`    | `/apps/:idOrSlug/accounts` | `User`      |                                                                                                    | 200 [`AppAccount[]`](Models.md#appaccount)                                                                                      | Get all the accounts for the authenticated user and given [`App`](Models.md#app).                                                                                                                                          |

### BillingPeriods

| Sr No | Method   | Endpoint              | MRR    | Request                                             | Response                                              | Comments                                  |
|-------|----------|-----------------------|--------|-----------------------------------------------------|-------------------------------------------------------|-------------------------------------------|
| 50    | `GET`    | `/billingPeriods`     | `User` | Query params-<br/>`date`: Optional. ISO8601 format. | <pre>[BillingPeriod](Models.md#billingperiod)[]</pre> | Lists all the billing-periods for a User. |
| 51    | `GET`    | `/billingPeriods/:id` | `User` |                                                     | <pre>[BillingPeriod](Models.md#billingperiod)</pre>   | Billing-period for the User.              |

### Docs

No endpoints.

### Plans

| Sr No | Method   | Endpoint     | MRR          | Request                                                                | Response                       | Comments                                                           |
|-------|----------|--------------|--------------|------------------------------------------------------------------------|--------------------------------|--------------------------------------------------------------------|
| 49    | `GET`    | `/plans`     |              |                                                                        | 200 [`Plan[]`](Models.md#plan) | Lists all pricing plans.                                           |
| 45    | `GET`    | `/plans/:id` |              |                                                                        | 200 [`Plan`](Models.md#plan)   | Get one pricing plan.                                              |
| 46    | `POST`   | `/plans`     | `PlanEditor` | Body-<br/>[`PlanCreationAttributes`](Models.md#plancreationattributes) | 200 [`Plan`](Models.md#plan)   | Create a pricing plan.                                             |
| 47    | `PUT`    | `/plans/:id` | `PlanEditor` | Body-<br/>[`PlanCreationAttributes`](Models.md#plancreationattributes) | 200 [`Plan`](Models.md#plan)   | Update a pricing plan.                                             |
| 48    | `DELETE` | `/plans/:id` | `PlanEditor` |                                                                        | 200 `{message: string}`        | Delete a pricing plan only if there is no solution with this plan. |

### Purchases

| Sr No | Method   | Endpoint                    | MRR    | Request                                                                               | Response                                                       | Comments                                                                                                                                                                                                                                                                             |
|-------|----------|-----------------------------|--------|---------------------------------------------------------------------------------------|----------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 12    | `GET`    | `/purchases`                | `User` |                                                                                       | 200 [`Purchase[]`](Models.md#purchase)                         | Lists all purchases for the authenticated user.                                                                                                                                                                                                                                      |
| 13    | `POST`   | `/purchases`                | `User` | [`PurchaseCreationAttributes`](Models.md#purchasecreationattributes)                  | 201 [`Purchase`](Models.md#purchase)                           | Creates a new [`Purchase`](Models.md#purchase) for the authenticated user.                                                                                                                                                                                                           |
| 14    | `GET`    | `/purchases/:id`            | `User` | `id` is the ID of a [`Purchase`](Models.md#purchase).                                 | 200 [`Purchase`](Models.md#purchase)                           | Get one [`Purchase`](Models.md#purchase)                                                                                                                                                                                                                                             |
| 15    | `PUT`    | `/purchases/:id`            | `User` | `id` is the ID of a [`Purchase`](Models.md#purchase).                                 | 501                                                            | Not implemented.                                                                                                                                                                                                                                                                     |
| 16    | `DELETE` | `/purchases/:id`            | `User` | `id` is the ID of a [`Purchase`](Models.md#purchase).                                 | 200                                                            | Delete the [`Purchase`](Models.md#purchase).                                                                                                                                                                                                                                         |
| 17    | `PUT`    | `/purchases/:id/pause`      | `User` | `id` is the ID of a [`Purchase`](Models.md#purchase).                                 | 200 `{message: string}`                                        | Pause the given [`Purchase`](Models.md#purchase).                                                                                                                                                                                                                                    |
| 18    | `PUT`    | `/purchases/:id/activate`   | `User` | `id` is the ID of a [`Purchase`](Models.md#purchase).                                 | 200 `{message: string}`                                        | Resume the given [`Purchase`](Models.md#purchase).                                                                                                                                                                                                                                   |
| 19    | `POST`   | `/purchases/:id/connect`    | `User` | `id` is the ID of a [`Purchase`](Models.md#purchase). Body - `{appAccountId: number}` | 200 [`AppAccountPurchaseMap`](Models.md#appaccountpurchasemap) | Connect an [`AppAccount`](Models.md#appaccount) to the given [`Purchase`](Models.md#purchase).<br/>The authenticated user must have access to both these objects.<br/>If another app-account of the same app was connected, that'll be replaced by this newly connected app-account. |
| 52    | `DELETE` | `/purchases/:id/disconnect` | `User` | `id` is the ID of a [`Purchase`](Models.md#purchase). Body - `{appAccountId: number}` | 200 [`AppAccountPurchaseMap`](Models.md#appaccountpurchasemap) | Disconnect an [`AppAccount`](Models.md#appaccount) from the given [`Purchase`](Models.md#purchase). Disconnecting any app-account also pauses the purchase, as it cannot function without all the app-accounts connected.                                                            |

### Solutions

| Sr No | Method   | Endpoint               | MRR              | Request                                                                                                                                                                                                                                                                                                                                  | Response                                                                                                                                  | Comments                                                                                                                                                                                                |
|-------|----------|------------------------|------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 20    | `GET`    | `/solutions`           |                  | Query params-<br/><ul><li>`searchTerm`: `string`,</li><li>`sorting`: 'popular' &#124; 'relevant' &#124; 'newest' &#124; 'staff_pick'</li><li>`apps`: `string[]`</li><li>`from`: `string` (ISO8601 date-time)</li><li>`to`: `string` (ISO8601 date-time)</li><li>`pageSize`: `number?` = 20</li><li>`pageNumber`: `number?` = 1</li></ul> | <pre>{<br/>&nbsp;&nbsp;data: [Solution](Models.md#solution)[],<br/>&nbsp;&nbsp;pagination: [Pagination](Models.md#pagination)<br/>}</pre> | Lists all [Solution](Models.md#solution) records. Maximum allowed value of `pageSize` is 200.                                                                                                           |
| 21    | `POST`   | `/solutions`           | `SolutionEditor` | <pre>{<br/>&nbsp;&nbsp;cfw: string,<br/>&nbsp;&nbsp;solutionCode: string,<br/>&nbsp;&nbsp;planId: number,<br/>&nbsp;&nbsp;type: number,<br/>&nbsp;&nbsp;name: string,<br/>&nbsp;&nbsp;active: boolean,<br/>&nbsp;&nbsp;apps: number[],<br/>&nbsp;&nbsp;descriptionPreview?: string,<br/>&nbsp;&nbsp;descriptionLong?: string<br/>}</pre> | 200 or 201 [`Solution`](Models.md#solution)                                                                                               | Creates a new [`Solution`](Models.md#solution) for all the users to use.                                                                                                                                |
| 22    | `GET`    | `/solutions/:idOrSlug` |                  | `id` is the ID of a [`Solution`](Models.md#solution).                                                                                                                                                                                                                                                                                    |                                                                                                                                           | Get one [`Solution`](Models.md#solution).                                                                                                                                                               |
| 23    | `PUT`    | `/solutions/:idOrSlug` | `SolutionEditor` | <pre>{<br/>&nbsp;&nbsp;solutionCode: string,<br/>&nbsp;&nbsp;planId: number,<br/>&nbsp;&nbsp;type: number,<br/>&nbsp;&nbsp;name: string,<br/>&nbsp;&nbsp;active: boolean,<br/>&nbsp;&nbsp;apps: number[],<br/>&nbsp;&nbsp;descriptionPreview?: string,<br/>&nbsp;&nbsp;descriptionLong?: string<br/>}</pre>                              | 200                                                                                                                                       | - CAUTION: There can be [purchases](Models.md#purchase) created by users against this [solution](Models.md#solution), please make sure that you know what you are doing.<br/>- `cfw` cannot be updated. |
| 24    | `DELETE` | `/solutions/:idOrSlug` | `SolutionEditor` | `id` is the ID of a [`Solution`](Models.md#solution).                                                                                                                                                                                                                                                                                    | 200                                                                                                                                       | Delete the [`Solution`](Models.md#solution).                                                                                                                                                            |

### Usage

| Sr No | Method | Endpoint | MRR    | Request                                                                                                                                                                                                                                                                   | Response                                  | Comments                                                            |
|-------|--------|----------|--------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|---------------------------------------------------------------------|
| 32    | `GET`  | `/usage` | `User` | Query params-<br/>`date`: ISO8601 to filter by the [BillingPeriod](Models.md#billingperiod) applicable on this date.<br/>`purchase`: ID of [Purchase](Models.md#purchase) object to filter for a `Purchase`.<br/>`forceUpdate`: To update the usage from CFW out of turn. | List of [Usage](Models.md#usage) objects. | Using `forceUpdate` is computationally-expensive, use sporadically. |

### UserPreferences

| Sr No | Method   | Endpoint           | MRR    | Request                                                                                            | Response                                         | Comments                                        |
|-------|----------|--------------------|--------|----------------------------------------------------------------------------------------------------|--------------------------------------------------|-------------------------------------------------|
| 41    | `GET`    | `/userPreferences` | `User` |                                                                                                    | 200 [`UserPreference`](Models.md#userpreference) |                                                 |
| 42    | `POST`   | `/userPreferences` | `User` | Request body-<br/>[`UserPreferenceCreationAttributes`](Models.md#userpreferencecreationattributes) | 201 [`UserPreference`](Models.md#userpreference) | Creates and associates with the logged-in user. |
| 43    | `PUT`    | `/userPreferences` | `User` | Request body-<br/>[`UserPreferenceCreationAttributes`](Models.md#userpreferencecreationattributes) | 200 `{message: string}`                          |                                                 |
| 44    | `DELETE` | `/userPreferences` | `User` |                                                                                                    | 200                                              |                                                 |

### Users

| Sr No | Method   | Endpoint                 | MRR     | Request                                                                                                                                                                                              | Response                                                    | Comments                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|-------|----------|--------------------------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 25    | `GET`    | `/users`                 | `Admin` |                                                                                                                                                                                                      | 200 [`User[]`](Models.md#user)                              | Lists all users.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| 26    | `GET`    | `/users/:id`             | `User`  | `id` is the ID of a [`User`](Models.md#user).                                                                                                                                                        | 200 [`User`](Models.md#user)                                | Get one [`User`](Models.md#user).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 27    | `PUT`    | `/users/:id`             | `User`  | [`User`](Models.md#user).                                                                                                                                                                            | 200 `{message: string}`                                     | Due to security concerns only the following attributes can be changed through this endpoint- `name`, `email`, `photoUrl`, `stripeCustomerId`, `paymentMethodAdded`, `teamId`, `socialAccessToken`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 28    | `DELETE` | `/users/:id`             | `User`  | `id` is the ID of a [`User`](Models.md#user).                                                                                                                                                        | 200 `{message: string}`                                     | Delete the [`User`](Models.md#user).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 29    | `POST`   | `/users/register`        |         | Request body-<br/><pre>{<br/>&nbsp;&nbsp;name: string?,<br/>&nbsp;&nbsp;email: string,<br/>&nbsp;&nbsp;password: string<br/>}</pre>                                                                  | 201 [`User`](Models.md#user) or 409                         | Creates a new [`User`](Models.md#user).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| 30    | `POST`   | `/users/login`           |         | Request body-<br/><pre>{<br/>&nbsp;&nbsp;provider: 'google'&#124;'apple'&#124;'github',<br/>&nbsp;&nbsp;idToken: string,<br/>&nbsp;&nbsp;email: string,<br/>&nbsp;&nbsp;password: string<br/>}</pre> | 200 [`User`](Models.md#user) or 400                         | If `provider` is set, `idToken` is mandatory. If `provider` is not set, `email` and `password` are mandatory.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 31    | `POST`   | `/users/forgot`          |         | Request body-<br/><pre>{<br/>&nbsp;&nbsp;email: string<br/>}</pre>                                                                                                                                   | 200 `{message: string}`                                     | To reset a password. It sends an email to the user with a reset link.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 33    | `GET`    | `/users/payment-methods` | `User`  |                                                                                                                                                                                                      | 200 Response from Stripe                                    | List payment methods added for the logged-in user                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 34    | `PUT`    | `/users/payment-methods` | `User`  | Request body-<br/><pre>{<br/>&nbsp;&nbsp;paymentMethodId: string,<br/>&nbsp;&nbsp;force: boolean?<br/>}</pre>                                                                                        | 200 Response from Stripe, or 404, 409 `{message: string}`   | Add a payment-method for the logged-in user. `paymentMethodId` is the ID of a payment-method on Stripe. A user can have only one payment-method added. If you want to overwrite the already added payment-method, set `force` to `true`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 
| 35    | `PUT`    | `/users/deactivate`      | `User`  |                                                                                                                                                                                                      | 200 `{message: string}`                                     | <ol><li>When this endpoint is invoked, first all the active purchases of the user are paused, and then user is disabled.</li><li>Billing is not disturbed, so a deactivated user will still get charged for the cost incurred before deactivation.</li><li>If for some reason, a purchase failed to get paused, all the purchases paused because of this invocation are resumed again, and the deactivation fails.</li><li>After calling this endpoint, log the user out on the frontend, because no existing tokens for this user shall work.</li><li>When this user logs in again, a token will be issued to him, but that token cannot access any endpoint unless endpoint 36 `PUT /users/activate` is called first.</li></ol> |
| 36    | `PUT`    | `/users/activate`        | `User`  |                                                                                                                                                                                                      | 200 `{message: string}`                                     | To activate a deactivated user. First show a confirmation box to the user to take his consent to activate his account, and then only call this endpoint.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 37    | `POST`   | `/users/change-password` | `User`  | Request body-<br/><pre>{<br/>&nbsp;&nbsp;newPassword: string,<br/>&nbsp;&nbsp;oldPassword: string?<br/>}</pre>                                                                                       | 200 [`User`](Models.md#User)                                | <ol><li>`oldPassword` is optional for users, who have no password set.</li><li>`newPassword` must be at least 6 characters long.</li><li>All old tokens will not work after the password change. Use the new token received in the `User` object in the response.</li></ol>                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 38    | `DELETE` | `/users/logout-all`      | `User`  |                                                                                                                                                                                                      | 200 [`User`](Models.md#User)                                | All the existing tokens issued to this user shall stop to work. The response of this endpoint contains a new token, that should be used for further requests.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 39    | `POST`   | `/users/profile-photo`   | `User`  | Request body-<br/>Image                                                                                                                                                                              | 200 `{message: string}`                                     | Make sure to set the Content-Type header to one of the `image/png`, `image/jpg`, or `image/jpeg`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 40    | `DELETE` | `/users/profile-photo`   | `User`  |                                                                                                                                                                                                      | 200 `{message: string}`                                     | Removes the profile-photo of the user.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 53    | `PUT`    | `/users/:id/stripe`      | `User`  |                                                                                                                                                                                                      | 200 `{stripeCustomerId: string}` or 40X `{message: string}` | Get stripeCustomerId for the user.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |

### WebSocket API

Usage data can be obtained as a stream through a websocket connection. The guide to use this stream is the following.

1. MRR is `User`.
2. socket.io is used to implement the socket connection.
3. The host is https://api.infinityweb.app.
4. When a user navigates to a page with task-meter on it, initiate the connection.
   ```javascript
   const socket = io('https://api.infinityweb.app', {auth: {token: 'token-here'}})
   ```
5. To listen for `usage` event.
    ```javascript
    socket.on('usage', (arg) => {console.log(arg)})
    ```
6. To set the purchase ID, emit `purchase` event with the ID of the purchase as its value.
    ```javascript
    socket.emit('purchase', 4)
    ```
7. When the user navigates away from this page, close the socket connection. Do not forget to close the connection, as
   it's really important for resource cleanup on the server-side.
    ```javascript
    socket.close()
    ```
